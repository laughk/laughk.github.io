<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>続・ラフなラボ</title>
        <link>http://memo.laughk.org/</link>
        <description>@laugh_k's memo</description>
        <language>en-us</language>
        <pubDate>Thu, 24 Apr 2014 00:00:00 +0900</pubDate>
        
        <item>
            <link>http://memo.laughk.org/2014/04/24/shell_exec_log.html</link>
            <guid>http://memo.laughk.org/2014/04/24/shell_exec_log.html</guid>
            <title><![CDATA[シェルスクリプトが '> $logfile 2>&1' だらけにならなくて済んだ話]]></title>
            <description><![CDATA[<div class="section" id="logfile-2-1">
<h1>シェルスクリプトが ‘&gt; $logfile 2&gt;&amp;1’ だらけにならなくて済んだ話</h1>
<dl class="docutils">
<dt>※ 2014-04-26</dt>
<dd><div class="first last line-block">
<div class="line">追記並びに一部コマンド部分の修正を行いました。( <span class="docutils literal"><span class="pre">&gt;</span></span> =&gt; <span class="docutils literal"><span class="pre">&gt;&gt;</span></span> に変更 )</div>
<div class="line">個人用のチラシの裏のつもりが予想以上に反響いただいていたようで非常にびっくりしております。</div>
</div>
</dd>
</dl>
<div class="line-block">
<div class="line">ちょっとしたバッチ処理的なものはさくっとシェルスクリプトでやっています。</div>
<div class="line">で、ログをとっておくべくリダイレクトを噛ますわけですが、</div>
<div class="line">スマートに書く方法を調べたのでメモ。</div>
</div>
<div class="line-block">
<div class="line">元ネタは <a class="reference external" href="https://twitter.com/sechiro">@sechiro</a> さんの <a class="reference external" href="http://sechiro.hatenablog.com/entry/2013/08/15/bash%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E7%BD%AE%E6%8F%9B%E6%A9%9F%E8%83%BD%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%97%E3%81%A6%E3%80%81%E3%82%B7%E3%82%A7%E3%83%AB%E4%BD%9C%E6%A5%AD%E3%82%84%E3%82%B9">bashのプロセス置換機能を活用して、シェル作業やスクリプト書きを効率化する</a> でございます。</div>
<div class="line">本当に参考になりました。ありがとうございます。</div>
</div>
<div id="more"> </div><div class="section" id="id1">
<h2>今までは</h2>
<p>こんなことやってたわけです。</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="nv">LOGFILE</span><span class="o">=</span>/tmp/script-log

command1 &gt;&gt; <span class="nv">$LOGFILE</span> 2&gt;&amp;1
command2 &gt;&gt; <span class="nv">$LOGFILE</span> 2&gt;&amp;1
...      &gt;&gt; <span class="nv">$LOGFILE</span> 2&gt;&amp;1
...      &gt;&gt; <span class="nv">$LOGFILE</span> 2&gt;&amp;1
...      &gt;&gt; <span class="nv">$LOGFILE</span> 2&gt;&amp;1
...      &gt;&gt; <span class="nv">$LOGFILE</span> 2&gt;&amp;1
</pre></div>
</div>
<p>まあ1,2行くらいならいいのですが、これが5行超えてくるともう編集するのも読むのも嫌になってきます。
この辺調べてみると、 <span class="docutils literal"><span class="pre">exec</span></span> コマンド <span class="strike">によるプロセス置換 で</span> で出力を変更してあげると良いようです。</p>
<dl class="docutils">
<dt><span class="docutils literal"><span class="pre">2014-04-26</span></span> 追記</dt>
<dd>下の例で出しています <span class="docutils literal"><span class="pre">awk</span></span> によるフィルタリングはプロセス置換にあたるようですが、
単純なログのリダイレクト部分については <span class="docutils literal"><span class="pre">bash</span></span> の組み込みコマンド <span class="docutils literal"><span class="pre">exec</span></span> によるリダイレクト指定の際の挙動のようで
プロセス置換とは別物のようです。勉強不足ですみません。。</dd>
</dl>
</div>
<div class="section" id="exec">
<h2>execで解決</h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="nv">LOGFILE</span><span class="o">=</span>/tmp/script-log

<span class="nb">exec </span>1&gt; &gt;<span class="o">(</span>cat &gt;&gt; <span class="nv">$LOGFILE</span><span class="o">)</span>
<span class="nb">exec </span>2&gt; &gt;<span class="o">(</span>cat &gt;&gt; <span class="nv">$LOGFILE</span><span class="o">)</span>

command1
command2
...
...
...
</pre></div>
</div>
<div class="line-block">
<div class="line">こんな感じで書けます。</div>
<div class="line">さらに <span class="docutils literal"><span class="pre">awk</span></span> も使って以下のようにすると、ログの各行の先頭に</div>
<div class="line"><span class="docutils literal"><span class="pre">[YYYY-mm-dd</span> <span class="pre">HH:MM:SS]</span></span>  のようにタイムスタンプも付けられます。</div>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="nv">LOGFILE</span><span class="o">=</span>/tmp/script-log

<span class="nb">exec </span>1&gt; &gt;<span class="o">(</span>awk <span class="s1">'{print strftime(&quot;[%Y-%m-%d %H:%M:%S] &quot;),$0 } { fflush() } '</span> &gt;&gt; <span class="nv">$LOGFILE</span><span class="o">)</span>
<span class="nb">exec </span>2&gt; &gt;<span class="o">(</span>awk <span class="s1">'{print strftime(&quot;[%Y-%m-%d %H:%M:%S] &quot;),$0 } { fflush() } '</span> &gt;&gt; <span class="nv">$LOGFILE</span><span class="o">)</span>

command1
command2
...
...
...
</pre></div>
</div>
<div class="line-block">
<div class="line"><span class="docutils literal"><span class="pre">tee</span></span> コマンドを使えば出力を保ちながらロギングとかもできそうです。</div>
<div class="line">ただしこの出力の変更は <span class="docutils literal"><span class="pre">bash</span></span> の機能らしく、シバンを <span class="docutils literal"><span class="pre">#!/bin/sh</span></span> にすると</div>
<div class="line"><span class="docutils literal"><span class="pre">Syntax</span> <span class="pre">error:</span> <span class="pre">redirection</span> <span class="pre">unexpected</span></span> が返って来てうまく処理が動かないので</div>
<div class="line"><span class="docutils literal"><span class="pre">#!/bin/bash</span></span> と書く必要が有ります。</div>
</div>
</div>
<div class="section" id="id2">
<h2>最後に</h2>
<p>ちょこちょこ処理が増えてきてしまうと
すぐに <span class="docutils literal"><span class="pre">&gt;&gt;</span> <span class="pre">$logfile</span> <span class="pre">2&gt;&amp;1</span></span> まみれになってしまっていたシェルスクリプトがようやくスッキリ書けるようになりました。
<span class="docutils literal"><span class="pre">exec</span></span> によるプロセス置換は他にも応用が効きそうなのでもっと調べると色々捗りそうです。</p>
</div>
<div class="section" id="id3">
<h2>2014-04-26 追記</h2>
<p>コメントにて更に素敵な方法を紹介していただけました。
<span class="docutils literal"><span class="pre">exec</span></span> 利用でもさらにシンプルな記載ができ、 また <span class="docutils literal"><span class="pre">{}</span></span>  を使った記載方法もあるようです。</p>
<ul>
<li><dl class="first docutils">
<dt>もっとシンプルな <span class="docutils literal"><span class="pre">exec</span></span></dt>
<dd><p class="first"><span class="docutils literal"><span class="pre">awk</span></span> などと組み合わせてフィルタリングするのは厳しいですが、単純に出力先を指定するにはこちらがよさそうです。</p>
<div class="last highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">LOGFILE</span><span class="o">=</span>/tmp/script-log
<span class="nb">exec</span> &gt;&gt;<span class="s2">&quot;$LOGFILE&quot;</span>
<span class="nb">exec </span>2&gt;&amp;1

command1
command2
...
...
...
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><span class="docutils literal"><span class="pre">{}</span></span> を使った方法</dt>
<dd><p class="first">この方法はコメントでご指摘いただくまで全く知りませんでした。。 こちらの記載方法のほうが汎用性が高そうで使いやすそうですね。</p>
<div class="last highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">LOGFILE</span><span class="o">=</span>/tmp/script-log

<span class="o">{</span>
    command1
    command2
    ...
    ...
    ...
<span class="o">}</span> &gt;&gt; <span class="s2">&quot;$LOGFILE&quot;</span> 2&gt;&amp;1
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<p>状況に応じて使い分けていければシェルスクリプトがもっと捗りそうです。</p>
</div>
</div>]]></description>
            <category><![CDATA[ tips ]]></category>
             <pubDate>Thu, 24 Apr 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://memo.laughk.org/2014/04/21/qpstudy_20140419_report.html</link>
            <guid>http://memo.laughk.org/2014/04/21/qpstudy_20140419_report.html</guid>
            <title><![CDATA[#qpstudy 2014.04 に参加してきたんで自分用まとめとか]]></title>
            <description><![CDATA[<div class="section" id="qpstudy-2014-04">
<h1>#qpstudy 2014.04 に参加してきたんで自分用まとめとか</h1>
<div class="line-block">
<div class="line">だいぶ出遅れてしまいましたが、先週末 <a class="reference external" href="http://www.zusaar.com/event/4897007">qpstudy 2014.04</a> に一般枠で参加させてもらってきたので</div>
<div class="line">感想や学びになったことのまとめをメモしておきます。</div>
</div>
<div id="more"> </div><p>他にもまとめている方が多いですが、セッションごとのスライドは以下の通り。</p>
<dl class="docutils">
<dt>第1セッション　構築作業の全体フェーズ</dt>
<dd><a class="reference external" href="http://www.slideshare.net/sho7650/ss-33703096">qpstudy 2014.04 インフラエンジニアとは、なんだ</a></dd>
<dt>第2セッション　今回の想定アーキテクチャとアーキテクチャ設計の勘所</dt>
<dd><a class="reference external" href="http://www.slideshare.net/sechiro/qpstudy201404">Qpstudy201404 インフラ設計の勘所</a></dd>
<dt>第3セッション　ハードウェア設計の勘所</dt>
<dd><a class="reference external" href="http://www.slideshare.net/TakeshiHasegawa1/qpstudy201404-dist">qpstudy 2014.04 ハードウェア設計の勘所</a></dd>
<dt>第4セッション　ネットワーク/OS設計の勘所</dt>
<dd><a class="reference external" href="http://www.slideshare.net/yktko/20140419qpstudyosnw">20140419【qpstudy】OSとNW設計の勘所</a></dd>
<dt>第5セッション　ミドルウェア（Web、Ap、DB）設計の勘所</dt>
<dd><a class="reference external" href="https://www.slideshare.net/nekoruri/4-33705917">qpstudy 2014.04 ミドルウェア設計の勘所</a></dd>
<dt>第6セッション　今後のインフラエンジニアとは</dt>
<dd>heartbeats <a class="reference external" href="https://twitter.com/netmarkjp">馬場さん(@netmarkjp)</a> によるプレゼン。こちらだけスライドは非公開</dd>
<dt>また当日の <span class="docutils literal"><span class="pre">Togetter</span></span> がまとめられておりました。</dt>
<dd><a class="reference external" href="http://togetter.com/li/657194">qpstudy 2014.04 〜俺の屍を超えて行け、でも踏まないで〜 #qpstudy</a></dd>
</dl>
<div class="section" id="id5">
<h2>全体的な感想をつらつらと</h2>
<div class="line-block">
<div class="line">各セクションの詳細だったりは他の方のブログや、すでに共有されているスライド、</div>
<div class="line"><span class="docutils literal"><span class="pre">Togetter</span></span> を見てもらえれば大丈夫そうなので割愛します。(今更感有りまししね。。)</div>
</div>
<div class="section" id="id6">
<h3>本編側</h3>
<div class="line-block">
<div class="line">私自身、 <span class="docutils literal"><span class="pre">MSP</span></span> の業務をやり始めてまだ2年半程度でとても経験豊富と言えるわけでもないため、</div>
<div class="line">今回の新人向けに企画していただいた各セッションはどれもスライドを何度も見返してしまうような刺さる内容ばかりでした。</div>
</div>
<div class="line-block">
<div class="line">その中でも特に最後の馬場さんのセッション内容は本当に基本的な部分でありながらも、</div>
<div class="line">時代が変わろうとも絶対変わらないだろうコアな部分を再認識出来ました。</div>
</div>
<dl class="docutils">
<dt>「段取り力」</dt>
<dd>過去にこれでコケて失敗してしまうことが何度もありました。何しても、何かをやる際はそのバックグラウンドを正しく見積もって段取りをしっかりやらなければいけないですね。</dd>
<dt>なんか合った時にシャっとうごいて成果を出す。</dt>
<dd>ローカルにフォーカスして、「隙間」を見つけてみようという視点は得意不得意があるかもしれませんが
確かに生き残っていく手段としては非常に大事な視点だと思いました。
同じ部署内でも、みんながなかなか手をつけられない、付けたがらないことにグイグイ首を突っ込んでいけると
自ずと振られる仕事もそちらの方面に持っていける傾向は確かにあるなと。
ただ、部署のカルチャーなども考慮すると、単純に「何の評価もされずに使い潰されて終わり」という状況にもなりかねないのでさじ加減は難しいところもあるかなとは感じました。</dd>
<dt>宿題が良かった</dt>
<dd>「さくらVPS+お名前ドットコムあたりの環境で、 <span class="docutils literal"><span class="pre">PHP</span></span> や <span class="docutils literal"><span class="pre">Ruby</span></span> でなにかサービスを作って動かして <span class="docutils literal"><span class="pre">qpstudy</span></span> で仲良くなった人たちに公開して運用してみよう」というものでした。
実は私が新卒で1年目だったあたりにも(状況は違ったでしょうが、、) 個人で利用できレンタルサーバーやDNSサービス自体はあったのだとは思いますが、当時私はその情報までたどり着けませんでした。
周りにそのノウハウや <span class="docutils literal"><span class="pre">Tips</span></span> を語ってくれる先輩等はいなかったというのが一番の原因では有りますが、具体的なサービス名を出してもらえると
業界に入りたての方でも最悪「とりあえずこのキーワードをググって...」から色々な可能性にトライしていけるのではないでしょうか。
なんだかんだで、多少業務で使ってるディストリビューションとズレがあったとしても、自分で管理できるサーバを実際に「運用」してみると、手っ取り早く色々なものを得ることができると思います。(私もそうでした)</dd>
</dl>
</div>
<div class="section" id="id7">
<h3>ビアバッシュ、懇親会</h3>
<div class="line-block">
<div class="line">雰囲気としては、<span class="docutils literal"><span class="pre">qpstudy</span></span> 自体は今回が2回めの参加となりましたが、</div>
<div class="line">なんとなく前回参加させていただいた際にちらっと耳にした「今回はなんかみんなおとなしい」の意味がわかった気がしました。w</div>
<div class="line">ビアバッシュが本当にカオスな感じで、みんなでビール飲みながらLTをやりながらワイワイ色々言い合ったりで、</div>
<div class="line">はじめの方は戸惑ったものの、十二分に楽しむことが出来ました。</div>
<div class="line"><br/></div>
<div class="line">今回は非公式の2次会まで参加させてもらいましたが、</div>
<div class="line">今自分が業務で扱っている仕事やら興味がある技術的な話を利害関係など関係なく</div>
<div class="line">話ができる人と出会えるのは本当にいいですね。</div>
</div>
</div>
</div>
</div>]]></description>
            <category><![CDATA[ 勉強会 ]]></category>
             <pubDate>Mon, 21 Apr 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://memo.laughk.org/2014/04/13/node_setagaya9_repo.html</link>
            <guid>http://memo.laughk.org/2014/04/13/node_setagaya9_repo.html</guid>
            <title><![CDATA[NODE-SetagayaでTerminalのTips的なものを話してきた]]></title>
            <description><![CDATA[<div class="section" id="node-setagayaterminaltips">
<h1>NODE-SetagayaでTerminalのTips的なものを話してきた</h1>
<p>しばらくの間参加できていなかった <span class="docutils literal"><span class="pre">NODE-Setagaya</span></span> に参加&amp; <span class="docutils literal"><span class="pre">Terminal</span></span> の <span class="docutils literal"><span class="pre">Tips</span></span> 的なものを話してきました。
当日利用したスライドはこちら。</p>
<ul>
<li><dl class="first docutils">
<dt><a class="reference external" href="https://speakerdeck.com/laughk/cli-mini-hack-number-1-terminaltofalseqin-mu-woshen-meyou">Cli mini Hack!#1 ~Terminalとの親睦を深めよう~</a></dt>
<dd><p class="first last"><span class="docutils literal"><span class="pre">Embed</span></span> しようとすると <span class="docutils literal"><span class="pre">Tinkerer</span></span> のビルドが何故かコケるのでリンクのみ共有です。。</p>
</dd>
</dl>
</li>
</ul>
<div id="more"> </div><div class="section" id="teminal">
<h2>Teminalの使い方の話をしようと思ったわけ</h2>
<div class="line-block">
<div class="line">これまで <span class="docutils literal"><span class="pre">NODE-Setagaya</span></span> で話をする機会があった際は</div>
<div class="line">「やってみたいんだけど、時間やきっかけなくてなかなか手が付けられてなかったものを扱うかなー」</div>
<div class="line">という感じでテーマを選んでいたことが多かったのですが、今回はちょっと視点を変えてみました。</div>
</div>
<div class="line-block">
<div class="line">そこそこの期間この業種で仕事してきたけど、案外自分の身の回りに <span class="docutils literal"><span class="pre">Twitter</span></span> 界隈とかにいそうな</div>
<div class="line">「ザ・ <span class="docutils literal"><span class="pre">Terminal</span></span> 大好き！」って人がなかなか自分の周りにいないなーと思っていたところと、</div>
<div class="line">割と自分自身では仕事を通じて <span class="docutils literal"><span class="pre">Terminal</span></span> で作業していると落ち着いくなーという人間になったので</div>
<div class="line">現状の「俺こうやってるけどみんなどう？」って感じのものを出してみればどんな反応があるのかな？</div>
<div class="line">という興味から今回のテーマを選んでみました。</div>
</div>
</div>
<div class="section" id="id1">
<h2>感想とか</h2>
<div class="line-block">
<div class="line">「これは知っている！」</div>
<div class="line">だったり</div>
<div class="line"><span class="docutils literal"><span class="pre">vim</span></span> のあたりでは「おー！これすげー！！」</div>
<div class="line">と反応してもらえたり</div>
<div class="line">「普段は面倒で調べるのが後回しになってた」</div>
<div class="line">などなど、参加メンツからは反応があり、</div>
<div class="line">テーマとしてはよいものが選べたかな。という手応えが有りました。</div>
</div>
<div class="line-block">
<div class="line">ちょっと直前にゴタゴタした状況で作ってしまい、</div>
<div class="line">かなり多めに時間を余してしまった点や、スライド自体がちゃんと閉められてなかったのは</div>
<div class="line">今回の反省点だったとは思います。</div>
</div>
<div class="line-block">
<div class="line">最初はやりたい内容を一度に全部流してしまうと、</div>
<div class="line">自分自身も結構しんどいし、そもそも参加しているみんながついてこれるか不安だったので</div>
<div class="line">今回の内容も人まずは基本的なところをピックアップした半分程度にとどめましたが、</div>
<div class="line">機会があったら、<span class="docutils literal"><span class="pre">DEMO6</span></span> の内容や今回扱いきれなかった部分を中心に</div>
<div class="line">また <span class="docutils literal"><span class="pre">CLI</span> <span class="pre">mini</span> <span class="pre">Hack</span></span> はやってみたいかなと思いました。</div>
</div>
</div>
</div>]]></description>
            <category><![CDATA[ 勉強会 ]]></category>
             <pubDate>Sun, 13 Apr 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://memo.laughk.org/2014/04/10/shell_lian_tower.html</link>
            <guid>http://memo.laughk.org/2014/04/10/shell_lian_tower.html</guid>
            <title><![CDATA[久々に第10回記念シェル芸勉強会行ってきたんでまとめとか]]></title>
            <description><![CDATA[<div class="section" id="id1">
<h1>久々に第10回記念シェル芸勉強会行ってきたんでまとめとか</h1>
<div class="line-block">
<div class="line">ブログ更新自体がかなりお久しぶりです。</div>
<div class="line">何とか生きてました。身の回りの環境が最近がらりと変わったわけですが、</div>
<div class="line">そのへんはまた近々別のエントリにでもしたいと思います。</div>
</div>
<div class="line-block">
<div class="line">今回は久々にシェル芸勉強会に行ってきたのでそのまとめを。</div>
<div class="line">といいつつも、実際の会場の様子は以下の <span class="docutils literal"><span class="pre">Togetter</span></span> を見てもらったほうが早いかと。</div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://togetter.com/li/651837">第10回記念シェル芸勉強会@シェルリアンタワー&amp;第28回場所が未定だったが決まったぞ定例会 - Togetterまとめ</a></li>
</ul>
<div id="more"> </div><div class="line-block">
<div class="line">過去のシェル芸勉強会ブログではいちいち自分の <span class="docutils literal"><span class="pre">Tweet</span></span> 拾って引用したりと面倒な真似してましたが、</div>
<div class="line">今回からは実際に自分で実行したコマンドたちは <span class="docutils literal"><span class="pre">gist</span></span> にまとめてみました。</div>
</div>
<script src="https://gist.github.com/laughk/10381390.js"/><p>最終問題についてはお察しください。</p>
<div class="section" id="id2">
<h2>収穫とか</h2>
<p>せっかくなので今回の収穫とか</p>
<ul>
<li><dl class="first docutils">
<dt><span class="docutils literal"><span class="pre">sed</span> <span class="pre">'s/./&amp;\n/g'</span></span> より <span class="docutils literal"><span class="pre">grep</span> <span class="pre">-o</span> <span class="pre">.</span></span> が便利。</dt>
<dd><p class="first">会場でたちまち <span class="docutils literal"><span class="pre">grep</span></span> ブームが発生しておりましたが、純粋にマッチ部分だけ抜き出す <span class="docutils literal"><span class="pre">-o</span></span> で縦表示にするテクニックがあるのに今まで気づかず目からウロコものでした。</p>
<div class="last highlight-sh"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo </span>aabbcdabbcccdd | grep -o .
a
a
b
b
c
d
a
b
b
c
c
c
d
d
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><span class="docutils literal"><span class="pre">grep</span> <span class="pre">-q</span></span> で結果を表示しない。</dt>
<dd><p class="first">これは個人的に地味にいいなと思ったしらなかったオプションで、今までシェルスクリプトを書くときなんかに「ファイル内に文字列があるかないか判定したいだけ」のときなんかリターンコードを見るためだけにわざわざ <span class="docutils literal"><span class="pre">grep</span></span> して <span class="docutils literal"><span class="pre">/dev/null</span></span> に捨てるような無駄なことをしていたのですが、これからはスッキリ書けそうです。</p>
<div class="last highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>grep huga file2
huga
<span class="nv">$ </span>grep -q huga file2
<span class="c">##  なにも表示されない</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><span class="docutils literal"><span class="pre">xargs</span></span> で余計なレイアウトを取っ払える。</dt>
<dd><p class="first">もはやシェル芸の定番と思っていた <span class="docutils literal"><span class="pre">xargs</span></span> もこの使い方は知らなかったです。具体的には以下のような感じ。</p>
<div class="last highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>cat toi2.txt
             1
2 3
                 4                     5
                                 6     7
 8         9
<span class="nv">$ </span>cat toi2.txt | xargs
1 2 3 4 5 6 7 8 9
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line">大きかったのはこのあたりです。他にも <span class="docutils literal"><span class="pre">awk</span></span> で <span class="docutils literal"><span class="pre">$0</span></span> をうまく置き換えることによって <span class="docutils literal"><span class="pre">print</span></span> を省略できたりとかありそうでしたが、</div>
<div class="line">この辺は色々試しながらものにしていきたいものです。</div>
</div>
</div>
<div class="section" id="id3">
<h2>感想とか</h2>
<div class="line-block">
<div class="line">勉強会自体、最近全然顔を出せていませんでしたが、</div>
<div class="line">シェル芸勉強会は私みたいな泥臭いインフラ運用なんかをやってる人間にとってはすぐに仕事に活かせそうな <span class="docutils literal"><span class="pre">Tips</span></span> がごろごろ転がってて</div>
<div class="line">楽しみながら習得できる感じが相変わらず良いですね。</div>
<div class="line">今回は懇親会まで行けませんでしたが、また次回参加したいですね。</div>
<div class="line">(といっても確か次回は大阪だったはず..orz)</div>
</div>
</div>
</div>]]></description>
            <category><![CDATA[ 勉強会 ]]></category>
             <pubDate>Thu, 10 Apr 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://memo.laughk.org/2013/12/10/ansible_with_infrastructure_engineer.html</link>
            <guid>http://memo.laughk.org/2013/12/10/ansible_with_infrastructure_engineer.html</guid>
            <title><![CDATA[あるインフラエンジニアとAnsibleの付き合い方]]></title>
            <description><![CDATA[<div class="section" id="ansible">
<h1>あるインフラエンジニアとAnsibleの付き合い方</h1>
<p>この記事は <a class="reference external" href="http://qiita.com/advent-calendar/2013/ansible">Ansible Advent Calender 2013</a> 10日目の記事です。</p>
<p>私は普段MSPな一応インフラエンジニア的なことをやっている人間ですが、
少しずつ今の仕事で <span class="docutils literal"><span class="pre">ansible</span></span> を利用し始めているのでその導入の際に障壁になったことや利用しているシーンを紹介したいと思います。</p>
<div id="more"> </div><div class="section" id="root">
<h2>障壁1 / root権限</h2>
<div class="line-block">
<div class="line">CentOSなどのRedHad系を中心に運用している場合は意外と <span class="docutils literal"><span class="pre">su</span> <span class="pre">-</span></span> が使えても <span class="docutils literal"><span class="pre">sudo</span></span> が使えない。という状況があるかもしれません。</div>
<div class="line"><span class="docutils literal"><span class="pre">fabric</span></span> の場合は無理やりprefixを弄って <span class="docutils literal"><span class="pre">su</span> <span class="pre">-c</span> <span class="pre">'command'</span></span> をやることができなくもないですが <a class="footnote-reference" href="#fabric-su-prifix" id="id1">[1]</a></div>
<div class="line"><span class="docutils literal"><span class="pre">ansible</span></span> の場合は公式で特に対応されるような気配はなく、モジュールを作るしかなさそうですがなんだか割に合わないような気もします。</div>
</div>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://github.com/ansible/ansible/pull/744">added su capability by willthames · Pull Request #744 · ansible/ansible · GitHub</a></li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line">私の場合もこの辺は完全に解消できているわけではないですが、極力自社で手が出せる範囲であったり</div>
<div class="line">新規構築の際に予め自動化の一環として説明して、少しずつ <span class="docutils literal"><span class="pre">sudo</span></span> を使える環境を増やしている状況です。</div>
<div class="line">ここは <span class="docutils literal"><span class="pre">ansible</span></span> に限らず他の <span class="docutils literal"><span class="pre">Provisioning</span></span> / <span class="docutils literal"><span class="pre">Orchestration</span></span> 系のツールを導入する際にも必要な最低ラインなんで、頑張って確保していくしかないと思います。</div>
</div>
</div>
<div class="section" id="id2">
<h2>障壁2 / 踏み台を超える</h2>
<div class="line-block">
<div class="line">ここも <span class="docutils literal"><span class="pre">ansible</span></span> に限った話ではないですが、</div>
<div class="line">お客さんの環境の運用を行っている場合、</div>
<div class="line">踏み台を経由しないとSSHアクセスができず、更に踏み台に勝手にツールを導入することができない。</div>
<div class="line">というケースが多いかと思います。イメージとしては以下のような感じ。</div>
</div>
<img alt="../../../_images/graph.png" src="http://memo.laughk.org/_images/graph.png"/>
<div class="line-block">
<div class="line">残念ながら <span class="docutils literal"><span class="pre">fabric</span></span> のように踏み台サーバ指定のオプションは無いようです。</div>
<div class="line">以下のPullリクエストがありながら取り込まれていないところを見ると今後もコマンドや <span class="docutils literal"><span class="pre">hostファイル</span></span> , <span class="docutils literal"><span class="pre">playbook</span></span> で管理できる状況になる可能性は低いかもしれません。</div>
</div>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://github.com/ansible/ansible/pull/2970">added support for ssh tunneling using ssh&amp;#39;s ProxyCommand option by rodlogic · Pull Request #2970 · ansible/ansible · GitHub</a></li>
</ul>
</div></blockquote>
<p>しかしながらヒント(というより答え)は↑のページにあります。</p>
<blockquote>
<div><div class="line-block">
<div class="line">There already is ANSIBLE_SSH_ARGS where you can specify all of SSH flags</div>
<div class="line">and override any Ansible may set by default, FWIW.</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">ということで環境変数 <span class="docutils literal"><span class="pre">ANSIBLE_SSH_ARGS</span></span> に <span class="docutils literal"><span class="pre">ssh</span></span> コマンドのオプションを渡すことができるようで、</div>
<div class="line">実際これに <span class="docutils literal"><span class="pre">ANSIBLE_SSH_ARGS='</span> <span class="pre">-F</span> <span class="pre">sshconfig.project'</span></span> みたいな感じで渡してあげれば sshconfig ファイルを使って</div>
<div class="line">各お客さんごとであったり、プロジェクトごとの踏み台環境を整えることができます。</div>
</div>
<div class="line-block">
<div class="line">これだけあれば、自社内の開発サーバだったり、</div>
<div class="line">最悪自分のPCのVM上などに環境を作ってしまえばなんとか使えるところまで持っていけます。</div>
</div>
<p>具体的には以下のように <span class="docutils literal"><span class="pre">sshconfig</span></span>, <span class="docutils literal"><span class="pre">host</span></span> ファイルを作っていけばOKです。</p>
<div class="section" id="sshconfig-project">
<h3>sshconfig.project</h3>
<p>踏み台、内側ネットワークでそれぞれ作成
(<span class="docutils literal"><span class="pre">Proxycommand</span></span> で <span class="docutils literal"><span class="pre">-F</span></span> で自分自身を指定するのを忘れずに)、</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">## 踏み台サーバ</span>
Host gateway
    User login_user
    IdentityFile /path/to/identity
    HostName xxx.xxx.xxx.xxx

<span class="c">## 接続先のLAN、ログイン情報</span>
Host 192.168.0.*
    User login_user
    Identityfile /path/to/identity
    Proxycommand ssh -F sshcondig.project gateway nc -w 120 %h %p
</pre></div>
</div>
</div>
<div class="section" id="host-project">
<h3>host.project</h3>
<p>必要に応じて作成</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="o">[</span>web<span class="o">]</span>
web01    <span class="nv">ansible_ssh_host</span><span class="o">=</span>192.168.0.11
web02    <span class="nv">ansible_ssh_host</span><span class="o">=</span>192.168.0.12
<span class="o">[</span>db<span class="o">]</span>
db01     <span class="nv">ansible_ssh_host</span><span class="o">=</span>192.168.0.21
</pre></div>
</div>
</div>
<div class="section" id="playbook-project-yml">
<h3>playbook-project.yml</h3>
<div class="line-block">
<div class="line">あとは <span class="docutils literal"><span class="pre">playbook-project.yml</span></span> などの名前で playbook を作成したら以下のような感じで実行するだけ</div>
<div class="line">状況によって内容は変わるんで今回は割愛します。</div>
</div>
</div>
<div class="section" id="id3">
<h3>実行</h3>
<p>ここまでできたら環境変数に気をつけて実行するだけです。</p>
<div class="highlight-sh"><div class="highlight"><pre>% <span class="nb">export </span><span class="nv">ANSIBLE_SSH_ARGS</span><span class="o">=</span><span class="s1">' -F sshconfig.project'</span>
% ansible-playbook playbook-project.yml -i host.project
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>利用シーンなど</h2>
<div class="line-block">
<div class="line"><span class="docutils literal"><span class="pre">Provisioning</span></span> / <span class="docutils literal"><span class="pre">Orchestration</span></span> に関するツールでは冪等性の話もかなり目にしますが、</div>
<div class="line">私の場合は複数の会社の人間が管理しているケースが多いため、</div>
<div class="line">構成の管理というよりは、多数のホストに同様の作業を行う場合に恩恵を受けるケースが多いです。</div>
<div class="line">そのため利用シーンは現状では以下のものに大体とどまっています。</div>
</div>
<blockquote>
<div><ul class="simple">
<li>全く同じ構成のサーバを複数構築する場合</li>
<li>お客さん側で環境全体に同じユーザーが必要になった場合 (ldapとか使えよって話かもですが、、)</li>
<li>複数台にドライバや診断ツールなどのベンダー配布のツールをインストールする場合</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line">最近ではコールドスタンバイ的な用途をしているサーバに対して</div>
<div class="line">playbook で構成を管理しておくと結構うれしいことが多いんじゃないかなんて考えていますが</div>
<div class="line">まだ実現に至っていません。</div>
</div>
</div>
<div class="section" id="id5">
<h2>最後に</h2>
<div class="line-block">
<div class="line">今回は具体的な <span class="docutils literal"><span class="pre">playbook</span></span> を載せたりとかはなかったですが、</div>
<div class="line"><span class="docutils literal"><span class="pre">ansible</span></span> はやはりymlで手軽に <span class="docutils literal"><span class="pre">task</span></span> を定義していけるんで非常に使いやすいのが気に入っています。</div>
<div class="line">またお客さんの環境を複数持っている場合、この手のツールは様々な事情で思うように導入できないケースも多いですが、</div>
<div class="line">クライアント側は <span class="docutils literal"><span class="pre">ssh</span></span> (CentOS5以下だと <span class="docutils literal"><span class="pre">python-simplejson</span></span> も必要) だけで使えるのというのも <span class="docutils literal"><span class="pre">ansible</span></span> の強みだと思います。</div>
<div class="line"><br/></div>
<div class="line">インフラ側からも十分利用価値のあるものですので、台数が多い環境の運用をされてる方なども利用を検討してみるとうれしいことがあるかもしれません。</div>
</div>
<p class="rubric">脚注</p>
<table class="docutils footnote" frame="void" id="fabric-su-prifix" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://stackoverflow.com/questions/12641514/switch-to-different-user-using-fabric">python - switch to different user using fabric  - Stack Overflow</a></td></tr>
</tbody>
</table>
</div>
</div>]]></description>
            <category><![CDATA[ Adventcalender ]]></category>
             <pubDate>Tue, 10 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://memo.laughk.org/2013/11/21/irc_setup_in_terminal.html</link>
            <guid>http://memo.laughk.org/2013/11/21/irc_setup_in_terminal.html</guid>
            <title><![CDATA[快適Terminal環境計画 - IRC -]]></title>
            <description><![CDATA[<div class="section" id="terminal-irc">
<h1>快適Terminal環境計画 - IRC -</h1>
<div class="line-block">
<div class="line">前から tmux と組み合わせて irc bouncer 的な使い方をしていた weechat ですが。</div>
<div class="line">いい加減本格的に移行したのでメモ。</div>
<div class="line">ちなみに私は今のところ Ubuntu13.10 な 24時間起動のサーバ立てて使っとります。</div>
</div>
<div id="more"> </div><div class="section" id="id1">
<h2>インストール</h2>
<p>ググって出てくる情報見るとapt版だとISO-2022-JPガーみたいな話あるようですが、最近は特に問題ないようです。</p>
<div class="highlight-sh"><div class="highlight"><pre>sudo aptitude install weechat
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>プラグインとか</h2>
<div class="line-block">
<div class="line">デフォで起動してもいいかもしれないですが、ここは先人の知恵に従って便利なプラグインを導入します。</div>
<div class="line">今のところは最低限以下のものだけ入れるだけでもだいぶ違います。</div>
</div>
<ul>
<li><dl class="first docutils">
<dt>weeget</dt>
<dd><p class="first last">weechatのプラグインを管理できるプラグイン</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>growl</dt>
<dd><p class="first last">ハイライトしたキーワードをネットワーク経由でGrowl通知してくれる。</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>highmon</dt>
<dd><p class="first last">ハイライトしたキーワードのレスだけを流してくれるバッファができる。</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>buffers</dt>
<dd><p class="first last">横に接続中のサーバ、入室中のチャンネルなどバッファの一覧を出してくれる。</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>go</dt>
<dd><p class="first last">指定したチャンネルにダイレクトにジャンプできる。関係ないチャンネルを既読にしないで飛べるので地味に便利。</p>
</dd>
</dl>
</li>
</ul>
<div class="line-block">
<div class="line">まずはweegetを導入して、他のプラグインを入れてあげればいい感じです。</div>
<div class="line">手順はこちらに従え問題無いかと -&gt; <a class="reference external" href="http://blog.glidenote.com/blog/2012/02/11/weechat-plugins">Weegetを利用して、WeeChatのPlugin管理を楽にする</a></div>
</div>
</div>
<div class="section" id="id3">
<h2>起動/設定</h2>
<div class="section" id="weechat-logger-conf">
<h3>~/.weechat/logger.conf</h3>
<div class="line-block">
<div class="line">ロギングはしときたいんでloggerの設定を以下のように変更します。</div>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">mask</span> <span class="o">=</span> <span class="s2">&quot;%plugin.$name/%Y%m%d.weechatlog&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="tmux-conf">
<h3>~/.tmux.conf</h3>
<div class="line-block">
<div class="line">tmux 内であげっぱなしにするので以下の設定も追加しときます。これをやっとかないと表示がおかしくなります。</div>
<div class="line">基本的にIRC内で流れていることは常にキャッチしておきたいのです。(まあbouncer使えよって話かもしれないですが)</div>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span class="nb">set</span> -g default-terminal <span class="s2">&quot;screen-256color&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>起動</h3>
<div class="line-block">
<div class="line">このあたりでtmux -&gt; weechatを起動</div>
</div>
<div class="highlight-sh"><div class="highlight"><pre>tmux
weechat-curses
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>設定</h3>
<div class="line-block">
<div class="line">接続先の設定</div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>## 普通のIRCサーバの場合
/server add example1 irc.example1.com/6667

## SSL かつ 起動時に自動で接続するように
/server add example2 irc.example2.com/6667 -ssl -autoconnect
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">オレオレ証明書(自己署名証明書)なSSLな場合は以下も実行します。</div>
<div class="line"><br/></div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>/set irc.server.example.ssl_verify = off
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">自分の名前とか拾いたいワードをhighlightに追加しときます</div>
<div class="line"><br/></div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>/set weechat.look.highlight *iwasaki*,*laughk*
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">growl プラグイン接続先も追加</div>
<div class="line">当然クライントPCにGrowlが入っていることが条件。ネットワーク経由での通知もできるようにしとく。</div>
<div class="line"><br/></div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>## 通常使うクライアントPCのIP情報
/set plugins.ver.python.growl.hostname 192.168.xxx.yyy

## クライアント側のGrowlパスワード
/set plugins.var.python.growl.password ****************
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">go プラグインのキーバインドもやっとく。</div>
<div class="line">ひとまずバッティングしなさそうだった Alt+g で</div>
<div class="line"><br/></div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>/key bind meta-g /go
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">iso-2022-jp なチャンネルは文字コードの設定も忘れずに。</div>
<div class="line">特にweechatは結構いい感じに文字コード直してくれたりするんで自分では化けてることに気づかないケースもあります。</div>
<div class="line"><br/></div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>## 対象のチャンネルで
/charset iso2022jp
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">他の細かいところなども <a class="reference external" href="http://www.weechat.org/doc">公式のドキュメント</a> 見ながら設定をして</div>
<div class="line">大体いいかなというところで変更を保存します。</div>
<div class="line"><br/></div>
</div>
<div class="highlight-irc"><div class="highlight"><pre>/save
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">こんな感じ。まあほぼ見せられないのでモザイクだらけですが</div>
<div class="line"><br/></div>
</div>
<img alt="../../../_images/shot2013-11-23_1.png" src="http://memo.laughk.org/_images/shot2013-11-23_1.png"/>
<div class="line-block">
<div class="line"><br/></div>
<div class="line">Yea!!</div>
<div class="line"><br/></div>
</div>
</div>
</div>
</div>]]></description>
             <pubDate>Thu, 21 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://memo.laughk.org/2013/11/18/hello_new_blog.html</link>
            <guid>http://memo.laughk.org/2013/11/18/hello_new_blog.html</guid>
            <title><![CDATA[ブログ移転]]></title>
            <description><![CDATA[<div class="section" id="id1">
<h1>ブログ移転</h1>
<p>これまでたまに <a class="reference external" href="http://laugh-labo.blogspot.com">ラフなラボ</a> の方でブログを書いてましたが
もう少し効率良くアウトプットしたいこともあって、
tinkerer + githubpage のこちらの環境に移行しました。
やっぱりReSTで書き留めたものをそのままBlogとして公開できるのは楽でいいですね。
(Octopress使わなかったのはMarkdownよりもReST使いたいから)</p>
<p>旧ブログを始めた頃に比べると大分目指すべき方向性も違ってきてしまっていたし、
まあ調度良いかなと。</p>
<p>このブログを立てる際の作業ログも後ほどまとめる予定。
ほとんど自分で面倒見なければいけないのはなかなか手間がかかった、、</p>
</div>]]></description>
             <pubDate>Mon, 18 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
    </channel>
</rss>